<div style="text-align: center">

# YaMDb API
</div>

<div style="text-align: justify">

## _Веб-сервис для обсуждения самых интересных и актуальных явлений в мире совеременного искусства._

![cover image](https://1.bp.blogspot.com/_5B4d8ajFBoQ/S__zVQaqC8I/AAAAAAAAArw/i9FbR_vUpCI/s1600/ron-mueck9.jpg)

![yamdb_final workflow](https://github.com/sammirabyan/yamdb_final/actions/workflows/yamdb_workflow.yml/badge.svg)

**YaMDb API** - учебный проект, основная цель которого - изучение принципов работы REST API (с использованием django, django REST Framework) и методов контейнеризации веб приложений (с использованием docker, docker-compose, nginx и postgresql). Этот проект - финальное задание 15-го спринта курса "Backend-разработчик на Python" сервиса онлайн-образования Яндекс.Практикум.

### Технические требования и зависимости

Для того, чтобы развернуть проект вам понадобятся установленные **docker** и **docker-compose**.
Остальные зависимости будут установлены из файлов docker:whale:.

### Как запустить
1. Склонируйте данный репозиторий.
2. Скопируйте на локальную машину или удаленный сервер следующие файлы и директории:
    - файл `docker-compose.yml`;
    - директорию `nginx/`;
3. Создайте файл `.env` в одной директории с файлом `docker-compose.yml` и укажите в нем необходимые переменные.
4. Запустите контейнеры
    ```shell
    docker-compose up -d --build
    ```
    Если у вас возникла ошибка `Error starting userland proxy: listen tcp4 0.0.0.0:80: bind: address already in use`, значит порт __80__ занят другим процессом.
    Найдите процесс, который занимает порт 80, и освободите этот порт. Затем повторите пункт 4. 
    Если вы на линуксе, освободить порт можно следующими двумя командами:
    ```shell
    sudo lsof -i:80 # так мы найдем id процесса
    sudo kill [process_id] # прервем процесс
    ```

    ...далее выполнится загрузка, сборка и запуск  контейнеров. В консоли должны появиться сообщения:

    ```
    ⠿ Container infra-db-1     Started
    ⠿ Container infra-web-1    Started
    ⠿ Container infra-nginx-1    Started
    ```

5. Контейнеры собраны, и запущены. Протестируйте работосопобность проекта.

- Откройте браузер и введите URL `localhost/redoc`.
Должна открыться страница браузера с документацией API сервиса yamdb.
- Если страница не загружается, скорее всего возникла какая-то ошибка с контейнерами (например веб контейнер постоянно перезагружается).
Проверьте состояние контнейров:
    ```shell
    sudo docker logs --tail 50 --follow --timestamps <container_name>
    ```
6. После устранения неполадок пора проверить работоспособность самого сервиса.
- Для этого выполните миграции для создания моделей БД:
    ```shell
    sudo docker-compose exec web python manage.py migrate
    ```
- Соберите статику проекта:
    ```shell
    sudo docker-compose exec web python manage.py collectstatic --no-input
    ```
7. Проверять запросы с пустой базой данных не очень-то интересно. Поэтому у сервиса есть удобная опция для тестирования эдпоинтов, которая позволяет загрузить тестовые данные и удалить их, когда это будет необходимо.
- Загрузите тестовые данные в БД:
    ```shell
    sudo docker-compose exec web python manage.py loadtestdata [--with_genres] [--no_genres] [--genres_only]
    ```
    <sub>флаг __--with_genres__ используется по умолчанию, так что если вы хотите наполнить модели тестовыми данными и заодно добавить к объектам модели Title данные о жанрах (модель Genre, связь many to many), то можете не добавлять никаких флагов.<br>
    флаг __--no_genres__ наполняет тестовыми даннми модели, но не добавляет к объектам модели Title данные о жанрах.<br>
    флаг __--genres_only__ только добавляет к объектам модели Title данные о жанрах (это значит, что модели должны быть предварительно наполнены).</sub>
- Откройте страницу документации сервиса `localhost/redoc`, там описаны валидные эндпоинты. Попробуйте сделать несколько запросов с помощью _curl_, _httpie_ или _postman_.
- Очистите базу данных:
    ```shell
    python manage.py flush
    ```
8. Проверьте работоспособность админки django:
- Cоздайте суперпользователя: 
    ```shell
    sudo docker-compose exec web python manage.py createsuperuser
    ```
- Перейдите на страницу админки `localhost/admin` и введите данные суперпользователя.
9. **Важно!** Во избежание артефактов БД после работы с тестовыми данными рекомендуется полностью удалить volume базы данных и вновь собрать контнейры.
10. **Важно**: обязательно измените workflow-инструкции файла `.github/workflows/foodgram_backend_workflow.yml` под нужды своего проекта. 

### Архитектура сервиса
Сервис собран в 3-х docker контейнерах, управляемых с помощью docker-compose:
- Nginx :mailbox_with_no_mail:: сервер статики и прокси сервер для бэкэнда;
- backend :electric_plug:: Django Rest Framework :gun: + Gunicorn :carousel_horse:;
- database :1234:: postgres (дефолтный image для docker).

### Основные фишки сервиса
- CRUD операции для таких моделей, как пользователи, жанры, категории, тайтлы (произведения), обзоры, комментарии;
- аутентификация пользователей посредством JWT-токенов;
- система ролей для пользователей со своими ограничениями;
- троттлинг входящих запросов и пагинация ответов;
- встроенная документация;
- тестовые данные для загрузки БД в корне проекта;
- предустановленный набор тест кейсов.

### Над чем еще нужно поработать
- добавить тесты;
- включить тестирование в этапы workflow.

### Над проектом работали
- спеки в redoc предоставлены [Yandex Praktikum Team](https://github.com/yandex-praktikum);
- backend и docker:whale:'ная часть написаны [Sam Mirabyan](https://sammirabyan.github.io).

</div>
